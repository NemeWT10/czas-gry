<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Miernik czasu gry</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <h1>Miernik czasu gry</h1>

  <div id="authSection">
    <label for="pwdInput">Has≈Ço:</label>
    <input type="password" id="pwdInput" placeholder="Podaj has≈Ço" />
    <button id="loginBtn">Zaloguj</button>
  </div>

  <h2>Wybierz graczy</h2>
  <div class="players" id="players"></div>

  <div class="buttons">
    <button id="startBtn" disabled>START</button>
    <button id="stopBtn" disabled>STOP</button>
    <button id="resetBtn" disabled>Resetuj czasy</button>
  </div>

  <h2>Podsumowanie czasu</h2>
  <table>
    <thead>
      <tr>
        <th>Gracz</th>
        <th>Czas (hh:mm:ss)</th>
        <th>Akcje</th>
      </tr>
    </thead>
    <tbody id="summaryBody"></tbody>
  </table>

  <!-- Supabase + logika timer√≥w -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <button onclick="loadTimes()">üîÑ Testuj loadTimes()</button>

<!-- Supabase + logika timer√≥w -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
/*  ===== 1. KONFIGURACJA SUPABASE ===== */
const SUPABASE_URL      = 'https://rwjmnrsqsqugftcdspfg.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJ3am1ucnNxc3F1Z2Z0Y2RzcGZnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDU0MTI5NDEsImV4cCI6MjA2MDk4ODk0MX0.ijTNOsWQJJJCMlecCcmuoM88Ue3oKiouQw17DwFZEW0';
const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

/*  ===== 2. STA≈ÅE / ZMIENNE APLIKACJI ===== */
const PLAYER_COUNT = 16;
const PASSWORD     = 'admin';
const players      = [];
const totals       = {};
const activeStarts = {};
let isAuthorized   = false;
let timerInterval  = null;

/*  ===== 3. ELEMENTY DOM ===== */
const playersContainer = document.getElementById('players');
const summaryBody      = document.getElementById('summaryBody');
const startBtn         = document.getElementById('startBtn');
const stopBtn          = document.getElementById('stopBtn');
const resetBtn         = document.getElementById('resetBtn');
const loginBtn         = document.getElementById('loginBtn');
const pwdInput         = document.getElementById('pwdInput');
const authSection      = document.getElementById('authSection');

/*  ===== 4. GENEROWANIE LISTY GRACZY ===== */
for (let i = 0; i < PLAYER_COUNT; i++) {
  const name = String.fromCharCode(65 + i);
  players.push(name);
  totals[name] = 0;

  const div = document.createElement('div');
  div.className = 'player';
  div.textContent = name;
  div.dataset.name = name;
  div.addEventListener('click', () => {
    if (!isAuthorized) return alert('Najpierw zaloguj siƒô has≈Çem.');
    div.classList.toggle('selected');
  });
  playersContainer.appendChild(div);

  const row = document.createElement('tr');
  row.innerHTML = `
    <td>${name}</td>
    <td id="time-${name}">00:00:00</td>
    <td><button class="editBtn" data-name="${name}" disabled>Edytuj</button></td>
  `;
  summaryBody.appendChild(row);
}

/*  ===== 5. FORMATOWANIE CZASU ===== */
function format(ms) {
  const sec = Math.floor(ms / 1000);
  const h   = String(Math.floor(sec / 3600)).padStart(2, '0');
  const m   = String(Math.floor((sec % 3600) / 60)).padStart(2, '0');
  const s   = String(sec % 60).padStart(2, '0');
  return `${h}:${m}:${s}`;
}

/*  ===== 6. LOGOWANIE LOKALNYM HAS≈ÅEM ===== */
loginBtn.addEventListener('click', () => {
  if (pwdInput.value === PASSWORD) {
    isAuthorized = true;
    authSection.style.display = 'none';
    enableControls();
  } else {
    alert('B≈Çƒôdne has≈Ço.');
  }
});

function enableControls() {
  startBtn.disabled = false;
  resetBtn.disabled = false;
  document.querySelectorAll('.editBtn').forEach(b => (b.disabled = false));
}

/*  ===== 7. POBIERANIE DANYCH Z SUPABASE ===== */
async function loadTimes() {
  console.log('[loadTimes] Start');
  const { data, error } = await supabase.from('player_times').select();

  if (error) {
    console.error('[loadTimes] SELECT error:', error.message);
    alert('B≈ÇƒÖd podczas pobierania danych z Supabase: ' + error.message);
    return;
  }

  console.log('[loadTimes] Otrzymane dane:', data);
  if (!data || !data.length) {
    console.warn('[loadTimes] Brak danych w tabeli!');
  }

  data.forEach(row => {
    console.log(`[loadTimes] Gracz: ${row.name}, Czas: ${row.total_ms} ms`);
    totals[row.name] = row.total_ms;
  });

  refreshSummary();
}

window.addEventListener('DOMContentLoaded', loadTimes);

/*  ===== 8. ZAPIS DO SUPABASE ===== */
async function syncTime(name) {
  console.log(`[syncTime] Zapisujƒô czas gracza ${name}: ${totals[name]} ms`);
  const { error } = await supabase
    .from('player_times')
    .upsert({ name, total_ms: totals[name] }, { onConflict: 'name' });

  if (error) {
    console.error(`[syncTime] B≈ÇƒÖd zapisu dla gracza ${name}:`, error.message);
    alert(`B≈ÇƒÖd zapisu do bazy dla ${name}: ${error.message}`);
  } else {
    console.log(`[syncTime] Zapis zako≈Ñczony dla gracza ${name}`);
  }
}

/*  ===== 9. OBS≈ÅUGA PRZYCISK√ìW START/STOP/RESET ===== */
startBtn.addEventListener('click', () => {
  if (!isAuthorized) return;
  const selected = [...document.querySelectorAll('.player.selected')];
  if (!selected.length) return alert('Zaznacz przynajmniej jednego gracza.');

  const now = Date.now();
  selected.forEach(el => {
    const name = el.dataset.name;
    if (!(name in activeStarts)) activeStarts[name] = now;
  });
  startBtn.disabled = true;
  stopBtn.disabled  = false;
  if (!timerInterval) timerInterval = setInterval(updateLiveTimes, 1000);
});

stopBtn.addEventListener('click', () => {
  if (!isAuthorized) return;
  const now = Date.now();
  for (const name in activeStarts) totals[name] += now - activeStarts[name];
  for (const k in activeStarts) delete activeStarts[k];

  startBtn.disabled = false;
  stopBtn.disabled  = true;
  clearInterval(timerInterval);
  timerInterval = null;
  refreshSummary();
  players.forEach(syncTime);
});

resetBtn.addEventListener('click', () => {
  if (!isAuthorized) return;
  if (!confirm('Czy na pewno zresetowaƒá wszystkie czasy?')) return;
  players.forEach(name => (totals[name] = 0));
  refreshSummary();
  players.forEach(syncTime);
});

/*  ===== 10. EDYCJA CZASU MANUALNA ===== */
summaryBody.addEventListener('click', e => {
  if (!e.target.classList.contains('editBtn')) return;
  if (!isAuthorized) return alert('Najpierw zaloguj siƒô has≈Çem.');

  const name = e.target.dataset.name;
  if (name in activeStarts)
    return alert('Zatrzymaj pomiar dla tego gracza przed edycjƒÖ czasu.');

  const current = format(totals[name]);
  const input = prompt(`Podaj nowy czas dla gracza ${name} (hh:mm:ss):`, current);
  if (!input) return;
  if (!/^\d\d:\d\d:\d\d$/.test(input.trim()))
    return alert('Niepoprawny format. U≈ºyj hh:mm:ss');

  const [hh, mm, ss] = input.split(':').map(Number);
  totals[name] = ((hh * 3600 + mm * 60 + ss) * 1000);
  refreshSummary();
  syncTime(name);
});

/*  ===== 11. OD≈öWIE≈ªANIE WIDOKU ===== */
function refreshSummary() {
  players.forEach(name => {
    document.getElementById('time-' + name).textContent = format(totals[name]);
  });
}
function updateLiveTimes() {
  const now = Date.now();
  players.forEach(name => {
    let val = totals[name];
    if (name in activeStarts) val += now - activeStarts[name];
    document.getElementById('time-' + name).textContent = format(val);
  });
}

/*  ===== 12. NAS≈ÅUCH REALTIME (opcjonalnie) ===== */
supabase.channel('player_times_updates')
  .on('postgres_changes',
      { event: '*', schema: 'public', table: 'player_times' },
      payload => {
        totals[payload.new.name] = payload.new.total_ms;
        refreshSummary();
      })
  .subscribe();
</script>


</body>
</html>
