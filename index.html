<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Miernik czasu gry</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <h1>Miernik czasu gry</h1>

  <div id="authSection">
    <label for="pwdInput">Hasło:</label>
    <input type="password" id="pwdInput" placeholder="Podaj hasło" />
    <button id="loginBtn">Zaloguj</button>
  </div>

  <h2>Wybierz graczy</h2>
  <div class="players" id="players"></div>

  <div class="buttons">
    <button id="startBtn" disabled>START</button>
    <button id="stopBtn" disabled>STOP</button>
    <button id="resetBtn" disabled>Resetuj czasy</button>
  </div>

  <h2>Podsumowanie czasu</h2>
  <table>
    <thead>
      <tr>
        <th>Gracz</th>
        <th>Czas (hh:mm:ss)</th>
        <th>Akcje</th>
      </tr>
    </thead>
    <tbody id="summaryBody"></tbody>
  </table>

  <!-- Supabase + logika timerów -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
/*  ===== 1. KONFIGURACJA SUPABASE ===== */
const SUPABASE_URL      = 'https://YOUR_SUPABASE_URL.supabase.co';
const SUPABASE_ANON_KEY = 'YOUR_SUPABASE_ANON_KEY';
const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

/*  ===== 2. STAŁE / ZMIENNE APLIKACJI ===== */
const PLAYER_COUNT = 16;
const PASSWORD     = 'admin';          // lok. hasło (możesz usunąć, gdy przejdziesz na Supabase Auth)

const players       = [];
const totals        = {};              // { A: ms, B: ms, ... }
const activeStarts  = {};              // { A: tsStart, ... }
let   isAuthorized  = false;
let   timerInterval = null;

/*  ===== 3. ELEMENTY DOM ===== */
const playersContainer = document.getElementById('players');
const summaryBody      = document.getElementById('summaryBody');
const startBtn         = document.getElementById('startBtn');
const stopBtn          = document.getElementById('stopBtn');
const resetBtn         = document.getElementById('resetBtn');
const loginBtn         = document.getElementById('loginBtn');
const pwdInput         = document.getElementById('pwdInput');
const authSection      = document.getElementById('authSection');

/*  ===== 4. GENEROWANIE LISTY GRACZY ===== */
for (let i = 0; i < PLAYER_COUNT; i++) {
  const name = String.fromCharCode(65 + i);
  players.push(name);
  totals[name] = 0;

  /* kafelek gracza */
  const div = document.createElement('div');
  div.className   = 'player';
  div.textContent = name;
  div.dataset.name = name;
  div.addEventListener('click', () => {
    if (!isAuthorized) return alert('Najpierw zaloguj się hasłem.');
    div.classList.toggle('selected');
  });
  playersContainer.appendChild(div);

  /* wiersz w tabeli */
  const row = document.createElement('tr');
  row.innerHTML = `
    <td>${name}</td>
    <td id="time-${name}">00:00:00</td>
    <td><button class="editBtn" data-name="${name}" disabled>Edytuj</button></td>
  `;
  summaryBody.appendChild(row);
}

/*  ===== 5. FORMATOWANIE CZASU ===== */
function format(ms) {
  const sec = Math.floor(ms / 1000);
  const h   = String(Math.floor(sec / 3600)).padStart(2, '0');
  const m   = String(Math.floor((sec % 3600) / 60)).padStart(2, '0');
  const s   = String(sec % 60).padStart(2, '0');
  return `${h}:${m}:${s}`;
}

/*  ===== 6. LOGOWANIE LOKALNYM HASŁEM  ===== */
loginBtn.addEventListener('click', () => {
  if (pwdInput.value === PASSWORD) {
    isAuthorized           = true;
    authSection.style.display = 'none';
    enableControls();
  } else {
    alert('Błędne hasło.');
  }
});
function enableControls() {
  startBtn.disabled = false;
  resetBtn.disabled = false;
  document.querySelectorAll('.editBtn').forEach(b => (b.disabled = false));
}

/*  ===== 7. POBIERANIE POCZĄTKOWYCH DANYCH Z SUPABASE ===== */
async function loadTimes() {
  const { data, error } = await supabase.from('player_times').select();
  if (error) return console.error('SELECT error', error);
  data.forEach(r => (totals[r.name] = r.total_ms));
  refreshSummary();
}
window.addEventListener('DOMContentLoaded', loadTimes);

/*  ===== 8. SYNC DO SUPABASE  ===== */
async function syncTime(name) {
  const { error } = await supabase
    .from('player_times')
    .upsert({ name, total_ms: totals[name] }, { onConflict: 'name' });
  if (error) console.error('UPSERT error', error);
}

/*  ===== 9. OBSŁUGA PRZYCISKÓW START/STOP/RESET ===== */
startBtn.addEventListener('click', () => {
  if (!isAuthorized) return;
  const selected = [...document.querySelectorAll('.player.selected')];
  if (!selected.length) return alert('Zaznacz przynajmniej jednego gracza.');

  const now = Date.now();
  selected.forEach(el => {
    const name = el.dataset.name;
    if (!(name in activeStarts)) activeStarts[name] = now;
  });
  startBtn.disabled = true;
  stopBtn.disabled  = false;
  if (!timerInterval) timerInterval = setInterval(updateLiveTimes, 1000);
});

stopBtn.addEventListener('click', () => {
  if (!isAuthorized) return;
  const now = Date.now();
  for (const name in activeStarts) totals[name] += now - activeStarts[name];
  for (const k in activeStarts) delete activeStarts[k];

  startBtn.disabled = false;
  stopBtn.disabled  = true;
  clearInterval(timerInterval);
  timerInterval = null;
  refreshSummary();
  players.forEach(syncTime);        // ⬅ zapisujemy każdy zmieniony wynik
});

resetBtn.addEventListener('click', () => {
  if (!isAuthorized) return;
  if (!confirm('Czy na pewno zresetować wszystkie czasy?')) return;
  players.forEach(name => (totals[name] = 0));
  refreshSummary();
  players.forEach(syncTime);
});

/*  ===== 10. EDYCJA RĘCZNA W TABELI ===== */
summaryBody.addEventListener('click', e => {
  if (!e.target.classList.contains('editBtn')) return;
  if (!isAuthorized) return alert('Najpierw zaloguj się hasłem.');

  const name = e.target.dataset.name;
  if (name in activeStarts)
    return alert('Zatrzymaj pomiar dla tego gracza przed edycją czasu.');

  const current = format(totals[name]);
  const input = prompt(`Podaj nowy czas dla gracza ${name} (hh:mm:ss):`, current);
  if (!input) return;
  if (!/^\d\d:\d\d:\d\d$/.test(input.trim()))
    return alert('Niepoprawny format. Użyj hh:mm:ss');

  const [hh, mm, ss] = input.split(':').map(Number);
  totals[name] = ((hh * 3600 + mm * 60 + ss) * 1000);
  refreshSummary();
  syncTime(name);                   // ⬅ zapis pojedynczego gracza
});

/*  ===== 11. ODŚWIEŻANIE WIDOKU ===== */
function refreshSummary() {
  players.forEach(name => {
    document.getElementById('time-' + name).textContent = format(totals[name]);
  });
}
function updateLiveTimes() {
  const now = Date.now();
  players.forEach(name => {
    let val = totals[name];
    if (name in activeStarts) val += now - activeStarts[name];
    document.getElementById('time-' + name).textContent = format(val);
  });
}

/*  ===== 12. (OPCJONALNIE) REALTIME PUSH  ===== */
supabase.channel('player_times_updates')
  .on('postgres_changes',
      { event: '*', schema: 'public', table: 'player_times' },
      payload => {
        totals[payload.new.name] = payload.new.total_ms;
        refreshSummary();
      })
  .subscribe();
</script>

</body>
</html>
