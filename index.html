<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Miernik czasu gry</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <h1>Miernik czasu gry</h1>

  <div id="authSection">
    <label for="pwdInput">Hasło:</label>
    <input type="password" id="pwdInput" placeholder="Podaj hasło" />
    <button id="loginBtn">Zaloguj</button>
  </div>

  <h2>Wybierz graczy</h2>
  <div class="players" id="players"></div>

  <div class="buttons">
    <button id="startBtn" disabled>START</button>
    <button id="stopBtn" disabled>STOP</button>
    <button id="resetBtn" disabled>Resetuj czasy</button>
  </div>

  <h2>Podsumowanie czasu</h2>
  <table>
    <thead>
      <tr>
        <th>Gracz</th>
        <th>Czas (hh:mm:ss)</th>
        <th>Akcje</th>
      </tr>
    </thead>
    <tbody id="summaryBody"></tbody>
  </table>

<!-- Supabase + logika timerów -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
/*  ===== 1. KONFIGURACJA SUPABASE ===== */
const SUPABASE_URL  = 'https://rwjmnrsqsqugftcdspfg.supabase.co';
const SUPABASE_KEY  = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJ3am1ucnNxc3F1Z2Z0Y2RzcGZnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDU0MTI5NDEsImV4cCI6MjA2MDk4ODk0MX0.ijTNOsWQJJJCMlecCcmuoM88Ue3oKiouQw17DwFZEW0';

/*  Klient Supabase – UŻYWAMY INNEJ NAZWY (sb)  */
const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

/*  ===== 2. STAŁE / ZMIENNE APLIKACJI ===== */
const PLAYER_COUNT = 16;
const PASSWORD     = 'admin';
const players      = [];
const totals       = {};
const activeStarts = {};
let isAuthorized   = false;
let timerInterval  = null;

/*  ===== 3. ELEMENTY DOM ===== */
const playersContainer = document.getElementById('players');
const summaryBody      = document.getElementById('summaryBody');
const startBtn         = document.getElementById('startBtn');
const stopBtn          = document.getElementById('stopBtn');
const resetBtn         = document.getElementById('resetBtn');
const loginBtn         = document.getElementById('loginBtn');
const pwdInput         = document.getElementById('pwdInput');
const authSection      = document.getElementById('authSection');

/*  ===== 4. GENEROWANIE LISTY GRACZY ===== */
for (let i = 0; i < PLAYER_COUNT; i++) {
  const name = String.fromCharCode(65 + i);
  players.push(name);
  totals[name] = 0;

  const div = document.createElement('div');
  div.className   = 'player';
  div.textContent = name;
  div.dataset.name = name;
  div.addEventListener('click', () => {
    if (!isAuthorized) return alert('Najpierw zaloguj się hasłem.');
    div.classList.toggle('selected');
  });
  playersContainer.appendChild(div);

  const row = document.createElement('tr');
  row.innerHTML = `
    <td>${name}</td>
    <td id="time-${name}">00:00:00</td>
    <td><button class="editBtn" data-name="${name}" disabled>Edytuj</button></td>
  `;
  summaryBody.appendChild(row);
}

/*  ===== 5. FORMAT CZASU ===== */
function format(ms) {
  const sec = Math.floor(ms / 1000);
  const h   = String(Math.floor(sec / 3600)).padStart(2, '0');
  const m   = String(Math.floor((sec % 3600) / 60)).padStart(2, '0');
  const s   = String(sec % 60).padStart(2, '0');
  return `${h}:${m}:${s}`;
}

/*  ===== 6. LOGOWANIE HASŁEM ===== */
loginBtn.addEventListener('click', () => {
  if (pwdInput.value === PASSWORD) {
    isAuthorized = true;
    authSection.style.display = 'none';
    startBtn.disabled = false;
    resetBtn.disabled = false;
    document.querySelectorAll('.editBtn').forEach(b => (b.disabled = false));
  } else {
    alert('Błędne hasło.');
  }
});

/*  ===== 7. ŁADOWANIE CZASÓW Z BAZY ===== */
async function loadTimes() {
  console.log('[loadTimes] Start');
  const { data, error } = await sb.from('player_times').select();
  if (error) {
    console.error('[loadTimes] SELECT error:', error.message);
    alert('Błąd pobierania danych z Supabase: ' + error.message);
    return;
  }
  data.forEach(r => (totals[r.name] = r.total_ms));
  refreshSummary();
}
window.addEventListener('DOMContentLoaded', loadTimes);

/*  ===== 8. ZAPIS DO BAZY ===== */
async function syncTime(name) {
  const { error } = await sb
    .from('player_times')
    .upsert({ name, total_ms: totals[name] }, { onConflict: 'name' });
  if (error) console.error(`[syncTime] ${name}:`, error.message);
}

/*  ===== 9. START / STOP / RESET ===== */
startBtn.addEventListener('click', () => {
  if (!isAuthorized) return;
  const selected = [...document.querySelectorAll('.player.selected')];
  if (!selected.length) return alert('Zaznacz przynajmniej jednego gracza.');
  const now = Date.now();
  selected.forEach(el => {
    const n = el.dataset.name;
    if (!(n in activeStarts)) activeStarts[n] = now;
  });
  startBtn.disabled = true;
  stopBtn.disabled  = false;
  if (!timerInterval) timerInterval = setInterval(updateLiveTimes, 1000);
});

stopBtn.addEventListener('click', () => {
  if (!isAuthorized) return;
  const now = Date.now();
  for (const n in activeStarts) totals[n] += now - activeStarts[n];
  Object.keys(activeStarts).forEach(k => delete activeStarts[k]);
  startBtn.disabled = false;
  stopBtn.disabled  = true;
  clearInterval(timerInterval);
  timerInterval = null;
  refreshSummary();
  players.forEach(syncTime);
});

resetBtn.addEventListener('click', () => {
  if (!isAuthorized) return;
  if (!confirm('Resetować wszystkie czasy?')) return;
  players.forEach(n => (totals[n] = 0));
  refreshSummary();
  players.forEach(syncTime);
});

/*  ===== 10. EDYCJA MANUALNA ===== */
summaryBody.addEventListener('click', e => {
  if (!e.target.classList.contains('editBtn')) return;
  if (!isAuthorized) return alert('Najpierw zaloguj się hasłem.');
  const n = e.target.dataset.name;
  if (n in activeStarts) return alert('Najpierw zatrzymaj stoper.');
  const cur = format(totals[n]);
  const inp = prompt(`Nowy czas dla ${n} (hh:mm:ss):`, cur);
  if (!inp || !/^\d\d:\d\d:\d\d$/.test(inp.trim()))
    return alert('Zły format (hh:mm:ss)');
  const [h,m,s] = inp.split(':').map(Number);
  totals[n] = ((h*3600+m*60+s)*1000);
  refreshSummary();
  syncTime(n);
});

/*  ===== 11. ODŚWIEŻANIE WIDOKU ===== */
function refreshSummary() {
  players.forEach(n => {
    document.getElementById('time-' + n).textContent = format(totals[n]);
  });
}
function updateLiveTimes() {
  const now = Date.now();
  players.forEach(n => {
    let val = totals[n];
    if (n in activeStarts) val += now - activeStarts[n];
    document.getElementById('time-' + n).textContent = format(val);
  });
}

/*  ===== 12. REALTIME (opcjonalnie) ===== */
sb.channel('player_times_updates')
  .on('postgres_changes',
      { event: '*', schema: 'public', table: 'player_times' },
      p => {
        totals[p.new.name] = p.new.total_ms;
        refreshSummary();
      })
  .subscribe();
</script>


</body>
</html>
